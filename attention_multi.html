
<!--
Loads
* attention: (heads, seqQ, seqK) array of floats
* tokens: (seq,) array of strings
-->

<script type='module'>

console.clear()

import {LitElement, html, css} from 'https://cdn.jsdelivr.net/gh/lit/dist@2/core/lit-core.min.js';

import {attention, tokens} from './data.js';

class AttentionMulti extends LitElement {
  static properties = {
  };

  constructor() {
    super();
  }

  render() {
    return html`
      <div>
        ${attention.map(matrix_for_head => html`
          <array-image .array=${matrix_for_head} .size=${300}></array-image>
        `)}
      </div>
    `;
  }
}
window.customElements.define('attention-multi', AttentionMulti);

class ArrayImage extends LitElement {
  static properties = {
    array: {type: Array},  // 2D array of floats
    size: {type: Number},  // pixels
  };

  constructor() {
    super();
    this.array = [];
    this.size = 0;
  }

  render() {
    // we make the canvas the size of the array (1px per entry), and upscale the canvas with CSS
    return html`
      <canvas width=${this.array.length} height=${this.array.length}
        style="width: ${this.size}px; height: ${this.size}px;"></canvas>
    `;
  }

  static styles = css`
    canvas {
      image-rendering: pixelated;
    }
  `;

  get canvas() { return this.shadowRoot.querySelector('canvas'); }

  updated(changedProperties) {
    this.draw();
  }

  draw() {
    const canvas = this.canvas;
    if (canvas.width != this.array[0].length || canvas.height != this.array.length) {
      canvas.width = this.array[0].length;
      canvas.height = this.array.length;
    }
    const ctx = canvas.getContext('2d');
    const bitmap = ctx.getImageData(0, 0, canvas.width, canvas.height);
    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        const value = this.array[y][x];
        const pixel = (y * canvas.width + x) * 4;  // 4 bytes per pixel, RGBA
        // monochromatic color scheme
        bitmap.data[pixel + 0] = value * 255  + 30 * (value > 0);
        bitmap.data[pixel + 1] = value * 255  + 30 * (value > 0);
        bitmap.data[pixel + 2] = value * 255  + 30 * (value > 0);
        bitmap.data[pixel + 3] = 255;
      }
    }
    ctx.putImageData(bitmap, 0, 0);
  }
}
window.customElements.define('array-image', ArrayImage);

</script>

<attention-multi />
