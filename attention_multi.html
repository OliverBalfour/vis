
<script type='module'>

import {LitElement, html, css} from 'https://cdn.jsdelivr.net/gh/lit/dist@2/core/lit-core.min.js';

// wrap everything in a function we immediately invoke to prevent polluting the global namespace
(function(){

// Load in the inputs Python leaves for us
const {
  attention,  // (heads, seqQ, seqK) array of floats
  tokens,     // (seq,) array of strings
} = window.latest_parameters;


class AttentionMulti extends LitElement {
  static properties = {
  };

  constructor() {
    super();
  }

  render() {
    return html`
      <div>
        ${attention.map(matrix_for_head => html`
          <array-image .array=${matrix_for_head} .size=${300}></array-image>
        `)}
      </div>
    `;
  }
}
window.customElements.define('attention-multi', AttentionMulti);


class ArrayImage extends LitElement {
  static properties = {
    array: {type: Array},  // 2D array of floats
    size: {type: Number},  // pixels
  };

  constructor() {
    super();
    this.array = [];
    this.size = 0;
  }

  render() {
    // We render the array as a grid of colored squares on an HTML5 canvas, a bitmap we can draw to
    // We make the canvas framebuffer/image the size of the array (1 pixel per entry), and upscale it
    // to screen resolution with CSS
    return html`
      <canvas width=${this.array.length} height=${this.array.length}
        style="width: ${this.size}px; height: ${this.size}px;"></canvas>
    `;
  }

  static styles = css`
    canvas {
      image-rendering: pixelated;
    }
  `;

  get canvas() { return this.shadowRoot.querySelector('canvas'); }

  updated(changedProperties) {
    this.draw();
  }

  draw() {
    // Update the canvas size
    const canvas = this.canvas;
    if (canvas.width != this.array[0].length || canvas.height != this.array.length) {
      canvas.width = this.array[0].length;
      canvas.height = this.array.length;
    }
    // Operate on the raw framebuffer/image data as a flattened (height, width, 4) array of int8's
    const ctx = canvas.getContext('2d');
    const bitmap = ctx.getImageData(0, 0, canvas.width, canvas.height);
    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        const value = this.array[y][x];
        const pixel = (y * canvas.width + x) * 4;  // 4 bytes per pixel, RGBA
        // monochromatic color scheme
        bitmap.data[pixel + 0] = value * 255  + 30 * (value > 0);
        bitmap.data[pixel + 1] = value * 255  + 30 * (value > 0);
        bitmap.data[pixel + 2] = value * 255  + 30 * (value > 0);
        bitmap.data[pixel + 3] = 255;
      }
    }
    ctx.putImageData(bitmap, 0, 0);
  }
}
window.customElements.define('array-image', ArrayImage);

})()
</script>

<!-- Render our component -->
<attention-multi />
